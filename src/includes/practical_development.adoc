= Desarrollo práctico

== Herramientas utilizadas

=== Kali

Distribución Linux basada en Debian, diseñada específicamente para pentest, auditorías de seguridad y evaluaciones de vulnerabilidades.

Su versión Bare Metal, consta de numerosas herramientas preinstaladas. Sin embargo, la versión Docker, que es la utilizada en este laboratorio, no cuenta con la mayoría de las que necesitamos para poder realizar el pentest. El paquete _kali-tools-top10_, incluye buena parte de ellas, el cual se instala al crear el contenedor, tal y como se especifica en el _Dockerfile_ del laboratorio.

https://www.kali.org[Web oficial Kali Linux]

=== Parrotsec

Al igual que Kali Linux, se trata de una distribución muy popular basada en Debian, orientada a pentest. Consta de un mayor repertorio de herramientas y los requisitos mínimos más bajos que Kali.

https://parrotsec.org[Web oficial Parrotsec]

=== Docker

Es una plataforma abierta de virtualización basada en contenedores, permite desplegar máquinas en un entorno aislado (sandbox) suponiendo un impacto en rendimiento para su host significativamente menor que el de una máquina virtual (VM).

A diferencia de las VM, los contenedores no constan de una interfaz gráfica. La ejecución de herramientas gráficas desde un contenedor, requiere el uso de un servidor X11 o VNC.

https://www.docker.com[Web oficial Docker]

=== Virtualbox

Software de virtualización de máquinas, permite cargar un sistema operativo al completo dentro de otro.

https://www.virtualbox.org[Web oficial VirtualBox]

== Laboratorio de pentest basado en contenedores

Para el desarrollo del presente proyecto, se ha diseñado una orquestación de contenedores Docker apta tanto para uso didáctico como para ser utilizada en un pentest real.

Dicha orquestación, consta de 6 contenedores (2 para pentest y 4 máquinas vulnerables):

* Kali Linux
* Parrot
* Metasploitable2
* Webgoat
* Juice-shop
* Damn Vulnerable Web Application (DVWA)

En el repositorio de este proyecto, se encuentra el script _main.sh_, consistente en una herramienta CLI para el despliegue de los contenedores, pudiendo seleccionar sólo aquellos que sean de nuestra preferencia, pues en un entorno de pentest real, no interesaría desplegar los contenedores vulnerables.

Adicionalmente, a fin de complementar la parte didáctica, se hace uso de una máquina virtual vulnerable Windows.

La topología de red consiste en:

* Una red bridge interna, sin acceso a internet, llamada "vulnerable" en la que se encuentran todos los contenedores.
* Una red bridge, llamada "pentest", en la que se encuentran los dos contenedores de pentest.

=== Requisitos previos

* Host Linux o macOS
* Docker 23.10 o superior (y Docker compose)
* Servidor X11 (sólo si se desean utilizar herramientas con entorno gráfico)

.Configuración del servidor X11 (macOS)

. Instalar Xquartz
+
.Instalación de Xquartz mediante brew
[source, bash]
----
brew install --cask xquartz
----
. Verificar que esté activada la opción "Permitir conexiones de clientes de red" en las preferencias de Xquartz +
.Preferencias de Xquartz
image::includes/images/x11_mac.png[Preferencias de Xquartz]
. Reiniciar el equipo
. Agregar IP del host a la lista de hosts remotos autorizados
+
.Agregar host autorizado
[source, bash]
----
xhost 192.168.1.3
----
. Configurar cookie de autenticación
+
.Generar cookie
[source, bash]
----
xauth generate $DISPLAY . trusted
xauth add $(xauth list $DISPLAY)
----
. Asignar la IP de nuestro host a la variable _HOST_IP_ del archivo _.env_

=== Despliegue del laboratorio

Para desplegar el laboratorio, sólo hay que ejecutar el script _main.sh_, seleccionar la opción "Start Lab" y escoger los contenedores que necesitemos.

Adicionalmente, el script consta de un acceso directo a la consola de los contenedores Kali y Parrot.

.Consola del laboratorio de pentest
image::includes/images/pentesting-lab.png[Consola del laboratorio de pentest]

== Pentest siguiendo la metodología Aika

En esta sección, se procede a ilustrar una demostración de White Box Pentest siguiendo las pautas establecidas en la metodología Aika, propuesta por los autores de este proyecto. El informe resultante del pentest se puede consultar en la sección <<informe>>.

Cabe destacar que al realizar el pentest sobre un laboratorio en vez de un entorno real y que los contenedores vulnerables no tienen acceso a internet, algunas pruebas de recopilación de información se realizan sobre servicios web reales.

=== Determinar el alcance y los objetivos del pentest

Consultar <<informe>>.

=== Descubrimiento

==== Recopilación de información

.Whois
Nos puede proporcionar información del propietario de un dominio así como datos de contacto.

.Ejemplo Whois
[source]
----
whois facebook.com
Domain Name: FACEBOOK.COM
Registry Domain ID: 2320948_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.registrarsafe.com
Registrar URL: http://www.registrarsafe.com
Updated Date: 2022-01-26T16:45:06Z
Creation Date: 1997-03-29T05:00:00Z
Registry Expiry Date: 2031-03-30T04:00:00Z
Registrar: RegistrarSafe, LLC
Registrar IANA ID: 3237
Registrar Abuse Contact Email: abusecomplaints@registrarsafe.com
Registrar Abuse Contact Phone: +1-650-308-7004
...
Registrant Organization: Meta Platforms, Inc.
Registrant Street: 1601 Willow Rd
Registrant City: Menlo Park
Registrant State/Province: CA
Registrant Postal Code: 94025
Registrant Country: US
Registrant Phone: +1.6505434800
Registrant Phone Ext:
Registrant Fax:
Registrant Fax Ext:
Registrant Email: domain@fb.com
----

.Maltego
Maltego es una herramienta gráfica de OSINT que permite aplicar transformaciones para el descubrimiento de datos.

.Análisis de metadatos
Se pueden obtener nombres de usuario, personal de la empresa y otros datos interesantes a partir de los metadatos de archivos PDF, DOCX, etc. Ver <<limpieza_metadatos>>.

.Dorking
Esta técnica utiliza los operadores de los motores de búsqueda para filtrar resultados. https://www.exploit-db.com/google-hacking-database[Exploit Database] consta de una base de datos de Dorks que puede proporcionar información muy útil para el pentest.

.Búsqueda por dominio en Shodan.io
image::includes/images/pentest/shodan.png[Captura de Shodan.io]

.Búsqueda por IP en Bing
image::includes/images/pentest/bing.png[Captura de Bing]

==== Mapeo de redes

_Nmap_ es un gran aliado a la hora de escanear una red. Comenzamos realizando un escaneo sobre la red vulnerable de Docker (10.0.1.0).

.Escaneo de red con Nmap
[source, bash]
----
# Identificar hosts en una red y su sistema operativo
nmap 10.0.1.0/24 -O

# Identificar puertos TCP abiertos
nmap 10.0.1.0/24 -sT

# Identificar puertos UDP abiertos entre los 100 más frecuentes
nmap 10.0.1.0/24 -sU -F
----

.Resultado del escaneo de red con Nmap
image::includes/images/pentest/nmap01.png[Salida Nmap]

Una vez identificados los puertos abiertos, procedemos a un análisis más específico para cada host. De los 4 contenedores vulnerables, tres son aplicaciones web y el otro Metasploitable2. Los contenedores de aplicaciones web vulnerables sólo tienen abiertos los puertos utilizados para servir las aplicaciones web, por lo que estos tres contenedores serán obviados de ahora en adelante hasta la fase de ejecución.

==== Identificación de vulnerabilidades

.Identificación de servicios con Nmap
[source]
----
# Obtener versión de los servicios expuestos en los puertos TCP enumerados
┌──(root㉿kali)-[~]
└─# nmap 10.0.1.4 -sV -sT -p "21, 22, 23, 25, 80, 111, 139, 445, 512, 513, 514, 1099, 1524, 2121, 3306, 5432, 6667, 8180"
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-02 10:48 UTC
Nmap scan report for lab-vulnerable1-1.lab_vulnerable (10.0.1.4)
Host is up (0.00019s latency).

PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
22/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
23/tcp   open  telnet      Linux telnetd
25/tcp   open  smtp        Postfix smtpd
80/tcp   open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
111/tcp  open  rpcbind     2 (RPC #100000)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
512/tcp  open  exec?
513/tcp  open  login
514/tcp  open  tcpwrapped
1099/tcp open  java-rmi    GNU Classpath grmiregistry
1524/tcp open  ingreslock?
2121/tcp open  ftp         ProFTPD 1.3.1
3306/tcp open  mysql       MySQL 5.0.51a-3ubuntu5
5432/tcp open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
6667/tcp open  irc         UnrealIRCd
8180/tcp open  unknown
----

* El protocolo SMTP es sensible a enumeración de usuarios, por lo que se procederá en la siguiente fase a un ataque por diccionario para obtener nombres de usuario.
* Aunque en la salida mostrada no aparece el puerto 2049, debido a que el contenedor de Metasploitable2 no cuenta con soporte completo para el servicio NFS, si se lanza el mismo comando sobre la versión original de Metasploitable2 (una máquina virtual), aparecen las versiones 2, 3 y 4 de NFS en el citado puerto. La versión 2 de NFS es vulnerable.
* Los servicios de MySQL, SSH y PostgreSQL se tratarán de vulnerar por la fuerza bruta.

include::pentest/metasploitable2.adoc[leveloffset=+2]
include::pentest/web_apps.adoc[leveloffset=+2]
include::pentest/social_engineering.adoc[leveloffset=+2]

=== Informes, limpieza y destrucción de información

En este punto, sólo se tratará la limpieza o borrado de huellas del pentest, puesto que puesto que los demás elementos de esta fase forman parte del <<informe>>.

[limpieza_metadatos]
==== Limpieza de metadatos

Además de borrar las huellas dejadas durante la realización del pentest, es deseable realizar una limpieza de metadatos del _PDF_ que se entregará al cliente. Para ello, es posible utilizar una herramienta online como https://metashieldclean-up.elevenpaths.com[Metashield]. En este caso, se procede a utilizar la herramienta por línea de comandos _qpdf_.

.Metadatos antes de limpiar
[source]
----
exiftool Temario.pdf
ExifTool Version Number         : 12.57
File Name                       : Temario.pdf
Directory                       : .
File Size                       : 772 kB
File Modification Date/Time     : 2018:12:23 09:58:28+00:00
File Access Date/Time           : 2023:04:08 22:14:35+00:00
File Inode Change Date/Time     : 2023:04:08 22:14:35+00:00
File Permissions                : -rwxrwxrwx
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 86
Language                        : es-ES
Tagged PDF                      : Yes
Author                          : Marín Martínez, Antonio
Creator                         : Microsoft® Word 2010
Create Date                     : 2017:03:14 18:38:33+01:00
Modify Date                     : 2017:03:14 18:38:33+01:00
Producer                        : Microsoft® Word 2010
----

.Limpieza con qpdf
[source, bash]
----
qpdf --linearize --empty --pages Temario.pdf -- Temario_clean.pdf
----

.Metadatos después del borrado
[source]
----
exiftool Temario_clean.pdf
ExifTool Version Number         : 12.57
File Name                       : Temario_clean.pdf
Directory                       : .
File Size                       : 693 kB
File Modification Date/Time     : 2023:04:08 22:26:17+00:00
File Access Date/Time           : 2023:04:08 22:26:16+00:00
File Inode Change Date/Time     : 2023:04:08 22:26:17+00:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : Yes
Page Count                      : 86
----
