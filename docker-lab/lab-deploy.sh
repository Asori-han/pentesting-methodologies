#!/bin/bash
source ${LAB_DIR}/lab/.env
cat ${LAB_DIR}/title.txt

### Colors ##
ESC=$(printf '\033') RESET="${ESC}[0m" BLACK="${ESC}[30m" RED="${ESC}[31m"
GREEN="${ESC}[32m" YELLOW="${ESC}[33m" BLUE="${ESC}[34m" MAGENTA="${ESC}[35m"
CYAN="${ESC}[36m" WHITE="${ESC}[37m" DEFAULT="${ESC}[39m"

### Color Functions ##

greenprint() { printf "${GREEN}%s${RESET}\n" "$1"; }
blueprint() { printf "${BLUE}%s${RESET}\n" "$1"; }
redprint() { printf "${RED}%s${RESET}\n" "$1"; }
yellowprint() { printf "${YELLOW}%s${RESET}\n" "$1"; }
magentaprint() { printf "${MAGENTA}%s${RESET}\n" "$1"; }
cyanprint() { printf "${CYAN}%s${RESET}\n" "$1"; }

docker_running() {
    if ! docker ps &>/dev/null; then
        return 1
    else
        return 0
    fi
}

docker_status() {
  if ! docker_running; then
    redprint 'NOT RUNNING'
  else
    greenprint $(docker --version | grep -o '[^ ,]\+' | sed -n 3p)
  fi
}

fn_bye() { echo "Bye bye."; exit 0; }
fn_fail() { echo "Wrong option."; }
status() { echo "Wrong option."; }

submenu() {
    echo -ne "
$(blueprint 'START LAB')
$(greenprint '1)') Kali container
$(yellowprint '2)') Parrot container
$(cyanprint '3)') Kali + vulnerable containers
$(redprint '4)') Parrot + vulnerable containers
$(greenprint '5)') All containers
$(blueprint '6)') Expose ports
$(greenprint '7)') Remove all containers
$(magentaprint '8)') Back
$(redprint '0)') Exit
Choose an option:  "
    read -r ans
    case $ans in
    1)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile kali-attacker up -d; cd ${WD}
        submenu
        ;;
    2)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile parrot-attacker up -d; cd ${WD}
        submenu
        ;;
    3)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile kali-attacker --profile vulnerable up -d; cd ${WD}
        submenu
        ;;
    4)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile parrot-attacker --profile vulnerable up -d; cd ${WD}
        submenu
        ;;
    5)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile kali-attacker --profile parrot-attacker --profile vulnerable up -d; cd ${WD}
        submenu
        ;;
    6)
        ${LAB_DIR}/lab/expose-ports.sh
        submenu
        ;;
    7)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile kali-attacker --profile parrot-attacker --profile vulnerable --profile documentation down; cd ${WD}
        fn_bye
        ;;
    8)
        ;;
    0)
        fn_bye
        ;;
    *)
        fn_fail
        ;;
    esac
}

mainmenu() {
    echo -ne "
$(magentaprint 'MAIN MENU')
$(greenprint '1)') Start Lab
$(yellowprint '2)') Kali console
$(cyanprint '3)') Parrot console
$(redprint '4)') Generate documentation
$(blueprint '5)') Refresh
$(redprint '0)') Exit
Docker: $(docker_status)
Host IP: $HOST_IP
Vulnerable network: $VULNERABLE_NETWORK
Choose an option:  "
    read -r ans
    case $ans in
    1)
        submenu
        mainmenu
        ;;
    2)
        docker exec -it lab-attacker1-1 /bin/bash
        mainmenu
        ;;
    3)
        docker exec -it lab-attacker2-1 /bin/bash
        mainmenu
        ;;
    4)
        WD=$(pwd); cd ${LAB_DIR}/lab; docker compose --profile documentation up -d; cd ${WD}
        docker exec -it lab-adocrenderer-1 /bin/bash -c "/documents/generate-pdf.sh" &>/dev/null
        greenprint "Done, you can find the document on root repo dir."
        mainmenu
        ;;
    5)
        mainmenu
        ;;
    0)
        fn_bye
        ;;
    *)
        fn_fail
        mainmenu
        ;;
    esac
}

mainmenu
