#!/bin/bash
function ports_request {
    end=false
    while ! $end; do
        read -p "Enter the ports to expose in the format 'container_port:host_port' or 'container_port_range:host_port_range', separated by commas: " PORTS_INPUT
        IFS=',' read -ra PORTS <<< "${PORTS_INPUT// /}"

        end=true
        for port in "${PORTS[@]}"; do
        if [[ ! $port =~ ^([0-9]+|[0-9]+-[0-9]+):([0-9]+|[0-9]+-[0-9]+)$ ]]; then
            echo "Error: $port is not a valid port in the format 'container_port:host_port' or 'container_port_range:host_port_range'"
            end=false
        fi
        done
    done

    if [ ${#PORTS[@]} -gt 0 ]; then
        echo "Ports entered correctly:"
        PORTS_STRING=$(printf -- '      - "%s"\n' "${PORTS[@]}")
        echo "$PORTS_STRING"
    fi
}

echo "Ports to expose on Kali:"
ports_request
KALI_PORTS=$PORTS_STRING
echo "Ports to expose on Parrot:"
ports_request
PARROT_PORTS=$PORTS_STRING

cat << EOF > ${LAB_DIR}/lab/ports.yaml
services:
  kali-ports:
    ports:
$KALI_PORTS
  parrot-ports:
    ports:
$PARROT_PORTS
EOF
